
pipeline {
    agent any   // We'll assign agents dynamically in stages

    parameters {
        string(name: 'TARGET_NODE', defaultValue: 'node1', description: 'Select agent/node1 to run tests')
        string(name: 'TARGET_NODE1', defaultValue: 'node1', description: 'Select agent/node1 to run tests')
        string(name: 'TARGET_NODE2', defaultValue: 'node2', description: 'Select agent/node2 to run tests')
        string(name: 'TARGET_NODE3', defaultValue: 'node3', description: 'Select agent/node3 to run tests')
       
        string(name: 'GROUPS', defaultValue: 'smoke,regression,sanity', description: 'Comma-separated TestNG groups')
        string(name: 'EXCEL_PATH', defaultValue: '/testng.xml', description: 'Excel test data path')
    }

    stages {

        stage('Checkout Code') {
            agent { label "${params.TARGET_NODE}" }
            steps {
                echo "Running checkout on node: ${params.TARGET_NODE}"
                dir('DataProviderProject/DataProviderProject') { 
                git branch: 'master', url: 'https://github.com/venkiralami/data_provider_project_ven.git'
                }
            }
        }

        stage('Run Tests in Parallel') {
            parallel {
                stage('Smoke Tests') {
                     agent { label "${params.TARGET_NODE}" }
                    steps {
						echo "Running Test type:: ${params.GROUPS} on node:: ${params.TARGET_NODE}"
                       dir('DataProviderProject/DataProviderProject/DataProviderProject') { 
                        bat "mvn clean test -Dgroups=${params.GROUPS} -Dexcel.path=${params.EXCEL_PATH}"
                    }
                    }
                }
                
               
            }
        }

    }

    post {
        always {
            echo "Pipeline finished at: ${new Date()}"
        }
        success {
            echo "All tests completed successfully!"
        }
        failure {
            echo "Some tests failed. Check the console output for details."
        }
    }
}
